name: Azure - Retrieve Key Vault Secrets

on:
  workflow_call:
    inputs:
      keyvault-name:
        description: 'Name of the Azure Key Vault'
        required: true
        type: string
      secret-names:
        description: 'Newline-separated list of secret names to retrieve'
        required: true
        type: string
    outputs:
      secrets-json:
        description: 'JSON object containing all retrieved secrets as key-value pairs'
        value: ${{ jobs.fetch-secrets.outputs.secrets-json }}

permissions:
  id-token: write
  contents: read

jobs:
  fetch-secrets:
    runs-on: ubuntu-latest
    outputs:
      secrets-json: ${{ steps.build-json.outputs.secrets-json }}
    steps:
      - name: Load Azure config
        id: azure_config
        shell: bash
        run: |
          set -euo pipefail
          CONFIG="$(curl -sS https://raw.githubusercontent.com/ignitia-core/ignitia-cicd-configuration/master/configuration.json)"
          TENANT_ID="$(jq -r .tenantId <<< "$CONFIG")"
          SUBSCRIPTION_ID="$(jq -r .subscriptionId <<< "$CONFIG")"
          CLIENT_ID="$(jq -r '.clients["github-oidc"].clientId' <<< "$CONFIG")"

          # expose as step outputs
          {
            echo "tenant-id=$TENANT_ID"
            echo "subscription-id=$SUBSCRIPTION_ID"
            echo "client-id=$CLIENT_ID"
          } >> "$GITHUB_OUTPUT"

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          tenant-id: ${{ steps.azure_config.outputs.tenant-id }}
          client-id: ${{ steps.azure_config.outputs.client-id }}
          subscription-id: ${{ steps.azure_config.outputs.subscription-id }}
          allow-no-subscriptions: true

      - name: Fetch secrets from Key Vault and build JSON
        id: build-json
        shell: bash
        run: |
          set -euo pipefail
          
          # Read secret names from input (newline-separated)
          SECRET_NAMES="${{ inputs.secret-names }}"
          KEYVAULT_NAME="${{ inputs.keyvault-name }}"
          
          # Initialize JSON object
          JSON_OUTPUT="{}"
          
          # Loop through each secret name and fetch from Key Vault
          while IFS= read -r secret_name; do
            # Skip empty lines
            [[ -z "$secret_name" ]] && continue
            
            echo "Fetching secret: $secret_name"
            
            # Fetch secret value using Azure CLI
            secret_value=$(az keyvault secret show \
              --vault-name "$KEYVAULT_NAME" \
              --name "$secret_name" \
              --query "value" \
              --output tsv)
            
            # Add secret value to GitHub Actions secret masking
            echo "::add-mask::$secret_value"
            
            # Add to JSON object (properly escaped)
            JSON_OUTPUT=$(jq -n \
              --arg key "$secret_name" \
              --arg value "$secret_value" \
              --argjson obj "$JSON_OUTPUT" \
              '$obj + {($key): $value}')
          done <<< "$SECRET_NAMES"
          
          # Output the JSON (values are already masked above)
          echo "secrets-json=$JSON_OUTPUT" >> "$GITHUB_OUTPUT"
          
          echo "âœ“ Successfully retrieved $(echo "$JSON_OUTPUT" | jq 'length') secrets"
