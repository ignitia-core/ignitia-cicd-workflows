name: oas-publish-clients

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: publish-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

on:
  workflow_call:
    inputs:
      aws-codeartifact-domain:
        type: string
        required: false
        default: "ignitia"
        description: "CodeArtifact domain name"
      aws-region:
        type: string
        required: false
        default: "eu-west-1"
        description: "AWS region"
      aws-role-arn:
        type: string
        required: true
        description: "IAM role ARN for GitHub OIDC"
      namespace:
        description: 'The namespace of the application (ex. Ignitia)'
        required: true
        type: string
      dotnet-version:
        description: 'The .NET version to use'
        required: false
        type: string
        default: "10.x"
      node-version:
        description: 'The Node.js version to use'
        required: false
        type: string
        default: "20"
      oas-file-path:
        type: string
        description: Path to the OpenAPI specification file
        required: false
        default: "src/oas.yaml"
      publish-source:
        type: string
        required: true
        description: "CodeArtifact repository to publish generated clients to"
      spectral-ruleset:
        type: string
        description: URL to the Spectral ruleset to use for validation
        required: false
        default: "https://raw.githubusercontent.com/ignitia-core/ignitia-tools-validators-spectral/refs/heads/master/spectral-ruleset.yaml"
      spectral-validation:
        type: boolean
        description: Validate the contract against Ignitia's spectral rules?
        default: true
      generate-dotnet:
        type: boolean
        description: Generate and publish .NET client?
        default: true
      generate-typescript:
        type: boolean
        description: Generate and publish TypeScript client?
        default: true

jobs:
  oas-publish-clients:
    name: oas-publish-clients
    runs-on: ubuntu-latest
    steps:
      # -------------------- AWS Authentication --------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      # -------------------- Phase 1: Login to Internal + Install Tools --------------------
      - name: Login to CodeArtifact (ignitia-internal - tools)
        run: |
          aws codeartifact login \
            --tool dotnet \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ignitia-internal
          aws codeartifact login \
            --tool npm \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ignitia-internal
          echo "‚úÖ Logged in to ignitia-internal (tools)"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install tools
        run: |
          dotnet tool install --global ignitia.generators.client
          npm install -g @stoplight/spectral-cli
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          echo "‚úÖ Installed generator, spectral, and yq"

      # -------------------- Phase 2: Login to Publish Source --------------------
      - name: Get CodeArtifact auth token
        id: codeartifact-token
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --query authorizationToken \
            --output text)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Get publish endpoints
        id: publish-endpoints
        run: |
          NUGET_ENDPOINT=$(aws codeartifact get-repository-endpoint \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ${{ inputs.publish-source }} \
            --format nuget \
            --query repositoryEndpoint \
            --output text)
          echo "nuget=${NUGET_ENDPOINT}v3/index.json" >> "$GITHUB_OUTPUT"
          
          NPM_ENDPOINT=$(aws codeartifact get-repository-endpoint \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ${{ inputs.publish-source }} \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "npm=${NPM_ENDPOINT}" >> "$GITHUB_OUTPUT"
          
          echo "‚úÖ Publish endpoints retrieved"

      - name: Login to CodeArtifact (publish source)
        run: |
          aws codeartifact login \
            --tool dotnet \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ${{ inputs.publish-source }}
          aws codeartifact login \
            --tool npm \
            --domain ${{ inputs.aws-codeartifact-domain }} \
            --repository ${{ inputs.publish-source }}
          echo "‚úÖ Logged in to ${{ inputs.publish-source }} (publish)"

      # -------------------- Checkout & Versioning --------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: workflow/repository
          fetch-depth: 0

      - name: Determine Semantic Version
        id: semver
        uses: ignitia-core/ignitia-cicd-actions/gitversion-generate-semver@master

      - name: Inject semantic version into OAS
        run: |
          sed -i "s/{{OAS_VERSION}}/${{ steps.semver.outputs.semantic-version }}/g" ./workflow/repository/${{ inputs.oas-file-path }}
          echo "‚úÖ Injected version ${{ steps.semver.outputs.semantic-version }}"

      # -------------------- Validation --------------------
      - name: Spectral validation
        if: inputs.spectral-validation
        run: |
          spectral lint ./workflow/repository/${{ inputs.oas-file-path }} -r ${{ inputs.spectral-ruleset }}
          echo "‚úÖ Contract validated"

      # -------------------- .NET Client --------------------
      - name: Generate .NET client
        if: inputs.generate-dotnet
        run: |
          generate-client dotnet \
            -c "workflow/repository/${{ inputs.oas-file-path }}" \
            -o "workflow/repository/Generated/DotNet/" \
            -n "${{ inputs.namespace }}" \
            -v "${{ steps.semver.outputs.semantic-version }}"
          echo "‚úÖ Generated .NET client"

      - name: Embed OAS contract in .NET package
        if: inputs.generate-dotnet
        run: |
          set -euo pipefail
          
          # Find the main contract project
          CONTRACT_PROJECT=$(find workflow/repository/Generated/DotNet -name "*Contract*.csproj" | head -1)
          
          if [ -z "$CONTRACT_PROJECT" ]; then
            echo "‚ö†Ô∏è  No Contract project found, trying any .csproj"
            CONTRACT_PROJECT=$(find workflow/repository/Generated/DotNet -name "*.csproj" | head -1)
          fi
          
          if [ -z "$CONTRACT_PROJECT" ]; then
            echo "‚ùå No .csproj found in generated output"
            exit 1
          fi
          
          PROJECT_DIR=$(dirname "$CONTRACT_PROJECT")
          echo "üìÅ Project directory: ${PROJECT_DIR}"
          
          # Copy OAS file as Contract.yaml (namespace will be added automatically)
          cp "workflow/repository/${{ inputs.oas-file-path }}" "${PROJECT_DIR}/Contract.yaml"
          echo "‚úÖ Copied OAS to ${PROJECT_DIR}/Contract.yaml"
          
          # Add embedded resource to .csproj if not already present
          if ! grep -q "Contract.yaml" "$CONTRACT_PROJECT"; then
            sed -i "/<\/Project>/i \\
            <ItemGroup>\\
              <EmbeddedResource Include=\"Contract.yaml\" />\\
            </ItemGroup>" "$CONTRACT_PROJECT"
            echo "‚úÖ Added embedded resource to ${CONTRACT_PROJECT}"
          else
            echo "‚ÑπÔ∏è  Embedded resource already configured"
          fi
          
          echo "‚úÖ Contract file embedded as Contract.yaml"

      - name: Package .NET client generation output
        if: inputs.generate-dotnet
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-generated-client-${{ steps.semver.outputs.semantic-version }}
          path: workflow/repository/Generated/DotNet/
          retention-days: 2
          if-no-files-found: error

      - name: Build .NET client
        if: inputs.generate-dotnet
        run: |
          dotnet restore workflow/repository/Generated/DotNet/Source/*.sln
          dotnet build workflow/repository/Generated/DotNet/Source/*.sln -c Release --no-restore
          echo "‚úÖ Built .NET client"

      - name: Pack .NET NuGet packages
        if: inputs.generate-dotnet
        run: |
          set -euo pipefail
          mkdir -p ./artifacts/nuget
          find workflow/repository/Generated/DotNet -name "*.csproj" -print0 | \
            xargs -0 -I {} dotnet pack {} \
              -c Release \
              --no-build \
              -p:PackageVersion=${{ steps.semver.outputs.semantic-version }} \
              -o ./artifacts/nuget
          echo "‚úÖ Packed $(ls -1 ./artifacts/nuget/*.nupkg 2>/dev/null | wc -l) NuGet package(s)"

      - name: Push .NET packages to CodeArtifact
        if: inputs.generate-dotnet
        run: |
          set -euo pipefail
          for pkg in ./artifacts/nuget/*.nupkg; do
            echo "üì¶ Pushing $(basename "$pkg") to ${{ inputs.publish-source }}..."
            dotnet nuget push "$pkg" \
              --source "${{ steps.publish-endpoints.outputs.nuget }}" \
              --api-key "Bearer ${{ steps.codeartifact-token.outputs.token }}" \
              --skip-duplicate
          done
          echo "‚úÖ Published .NET packages to ${{ inputs.publish-source }}"

      # -------------------- TypeScript Client --------------------
      - name: Generate TypeScript client
        if: inputs.generate-typescript
        run: |
          generate-client typescript \
            -c "workflow/repository/${{ inputs.oas-file-path }}" \
            -o "workflow/repository/Generated/TypeScript/" \
            -n "${{ inputs.namespace }}" \
            -v "${{ steps.semver.outputs.semantic-version }}"
          echo "‚úÖ Generated TypeScript client"

      - name: Build TypeScript client
        if: inputs.generate-typescript
        run: |
          cd workflow/repository/Generated/TypeScript
          npm install
          npm run build
          echo "‚úÖ Built TypeScript client"

      - name: Publish TypeScript package to CodeArtifact
        if: inputs.generate-typescript
        run: |
          cd workflow/repository/Generated/TypeScript
          
          REGISTRY="${{ steps.publish-endpoints.outputs.npm }}"
          REGISTRY_HOST=$(echo "$REGISTRY" | sed 's|https://||')
          
          npm config set "//${REGISTRY_HOST}:_authToken" "${{ steps.codeartifact-token.outputs.token }}"
          npm config set registry "$REGISTRY"
          
          npm publish
          echo "‚úÖ Published TypeScript package to ${{ inputs.publish-source }}"

      # -------------------- Release Creation --------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.semver.outputs.semantic-version }}
          name: Release ${{ steps.semver.outputs.semantic-version }}
          body: |
            ## Generated Clients
            
            ### .NET
            - **Package**: `${{ inputs.namespace }}.Client`
            - **Version**: `${{ steps.semver.outputs.semantic-version }}`
            - **Feed**: `${{ inputs.publish-source }}`
            
            ### TypeScript
            - **Package**: `@${{ inputs.namespace }}/client` (lowercase)
            - **Version**: `${{ steps.semver.outputs.semantic-version }}`
            - **Feed**: `${{ inputs.publish-source }}`

            ## Installation
            **NuGet**:
            ```bash
            dotnet add package ${{ inputs.namespace }}.Client --version ${{ steps.semver.outputs.semantic-version }}
            ```
            
            **npm**:
            ```bash
            npm install @<namespace>/client@${{ steps.semver.outputs.semantic-version }}
            ```
            
            Replace `<namespace>` with lowercase `${{ inputs.namespace }}`.

          draft: false
          prerelease: ${{ contains(steps.semver.outputs.semantic-version, '-') }}
          generate_release_notes: false

      # -------------------- Summary --------------------
      - name: Summary
        run: |
          echo "## üì¶ Published Clients" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.semver.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Publish Target:** ${{ inputs.publish-source }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.generate-dotnet }}" = "true" ]; then
            echo "### .NET" >> $GITHUB_STEP_SUMMARY
            echo "- Package: \`${{ inputs.namespace }}.Client\`" >> $GITHUB_STEP_SUMMARY
            echo "- Feed: \`${{ inputs.publish-source }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.generate-typescript }}" = "true" ]; then
            echo "### TypeScript" >> $GITHUB_STEP_SUMMARY
            NAMESPACE_LOWER=$(echo "${{ inputs.namespace }}" | tr '[:upper:]' '[:lower:]')
            echo "- Package: \`@${NAMESPACE_LOWER}/client\`" >> $GITHUB_STEP_SUMMARY
            echo "- Feed: \`${{ inputs.publish-source }}\`" >> $GITHUB_STEP_SUMMARY
          fi
